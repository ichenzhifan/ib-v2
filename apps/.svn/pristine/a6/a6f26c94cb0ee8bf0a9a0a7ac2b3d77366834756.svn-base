import { combineReducers } from 'redux';
import { merge, get, set, pick, forEach, isEmpty } from 'lodash';
import { PENDING, DONE, PROGRESS, FAIL } from '../contants/uploadStatus';
import { ADD_IMAGES, UPDATE_IMAGEID, UPDATE_PERCENT, UPLOAD_COMPLETE, UPDATE_FIELDS, CLEAR_IMAGES, DELETE_IMAGE, ERROR_TO_FIRST } from '../contants/actionTypes';
/**
 * 处理上传的图片.
 * @param state
 * @param action
 * @returns {*}
 */
const uploadedImages = (state = [], action) => {
  switch (action.type) {
    case ADD_IMAGES :
      const files = Array.from(action.files);
      const newState = files.map((file)=>{
        return {
          name : file.name,
          guid : '',
          imageId : '',
          xhr : null,
          file : null,
          info : '',
          uploadTime : '',
          status : PENDING,
          totalSize : 0,
          uploadedSize : 0,
          percent : 0,
        }
      })
      return [
        ...state,
        ...newState
      ];
    case UPDATE_FIELDS:
      const index = state.findIndex((item)=>{
        return item.imageId==action.imageId
      });

      return set(merge([], state), `${index}`,merge({}, state[index], action.fields));
    case UPDATE_IMAGEID :
      return set(merge([], state), `${action.index}.imageId`,action.imageId);
    case UPDATE_PERCENT :
      var index = state.findIndex((item)=>{
        return item.imageId==action.imageId
      });
      action.percent = action.percent == 100 ? 99 : action.percent;
      return set(merge([], state), `${index}.percent`,action.percent);
    case CLEAR_IMAGES:
        return [];
    case DELETE_IMAGE:
        var index = state.findIndex((item)=>{
          return item.imageId==action.imageId
        });
        return [
          ...state.slice(0,index),
          ...state.slice(index+1)
        ];
    case ERROR_TO_FIRST:
        var index = state.findIndex((item)=>{
          return item.imageId==action.imageId
        });
        const copyState = merge([],state);
        const errorItem = copyState.splice(index,1);
        copyState.unshift(errorItem[0]);
        return copyState;
    default :
      return state;
  }
};

export default uploadedImages;
