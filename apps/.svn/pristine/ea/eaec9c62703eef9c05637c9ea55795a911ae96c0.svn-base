import React, { Component, PropTypes } from 'react';
import { merge, isEqual } from 'lodash';
import { drawImage, clear, drawDashedLine } from '../../utils/draw';
import classNames from 'classnames';
import XHandler from '../XHandler';
import './index.scss';

export default class XTextElement extends Component {
  constructor(props) {
    super(props);
    this.state = {
      disX: 0,
      disY: 0
    };
  }

  /**
   * 性能提升, 只要宽高和图片的属性发生变化时才重新渲染.
   * @param nextProps
   * @param nextState
   */
  shouldComponentUpdate(nextProps, nextState) {
    const isUpdated = !isEqual({
      width: this.props.width,
      height: this.props.height,
      options: this.props.options
    }, {
      width: nextProps.width,
      height: nextProps.height,
      options: nextProps.options
    });

    return isUpdated;
  }

  /**
   * 渲染图片.
   */
  componentDidMount() {
    const { canvasId, width, height, options } = this.props;
    const { textUrl } = options;

    // 加载图片并绘制.
    clear(canvasId, 0, 0, width, height);
    drawImage(canvasId, textUrl, 0, 0, null, width, height);
    this.drawDashedRect();
  }

  drawDashedRect() {
    const { canvasId, width, height, options } = this.props;
    const color = '#f7f7f7';
    //top
    drawDashedLine(canvasId, color, -1, 0, width, 0, 1, 3);
    //left
    drawDashedLine(canvasId, color, 0, 0, 0, height, 1, 3);
    //right
    drawDashedLine(canvasId, color, width, 0, width, height, 1, 3);
    //bottom
    drawDashedLine(canvasId, color, 0, height, width, height, 1, 3);
  }

  handleMouseDown(event) {
    const { handleMouseDown, options } = this.props;
    const disX = event.pageX - options.x;
    const disY = event.pageY - options.y;
    this.setState({
      disX: disX,
      disY: disY
    });
    handleMouseDown && handleMouseDown(event);
  }

  handleMouseMove(event) {
    const { handleMouseMove, options } = this.props;
    const { disX, disY } = this.state;
    const { id } = options;
    const x = event.pageX - disX;
    const y = event.pageY - disY;
    handleMouseMove && handleMouseMove({
      id,
      x,
      y
    })
  }

  render() {
    const { className, children, handleMouseMove, handleMouseDown, canvasId, width, height, options } = this.props;
    const customClass = classNames('x-text-element', className);
    // 定位textElement
    const styles = {
      top: `${options.y}px`,
      left: `${options.x}px`
    };
    return (
      <div className={customClass} style={styles}>
        <canvas id={canvasId} width={width} height={height}></canvas>
        {children}
        {/* 控制元素, 用于控制渲染出来的图片, 如缩放, 旋转等 */}
        <XHandler handleMouseDown={this.handleMouseDown.bind(this)}
                  handleMouseMove={this.handleMouseMove.bind(this)}/>
      </div>
    );
  }
}

XTextElement.propTypes = {
  className: PropTypes.string,

  // 画布的宽和高
  width: PropTypes.number.isRequired,
  height: PropTypes.number.isRequired,

  // 线的位置信息
  options: PropTypes.shape({
    textUrl: PropTypes.string.isRequired,
    lineWidth: PropTypes.number,
    top: PropTypes.number,
    left: PropTypes.number
  }).isRequired
};
