import React, {Component, PropTypes} from 'react';
import XModal from '../../../../common/ZNOComponents/XModal';
import XButton from '../../../../common/ZNOComponents/XButton';
import Spread from '../../components/Spread';
import OutInSide from '../OutInSide';
import {translate} from 'react-translate';
import { merge, template, get, set } from 'lodash';
import { workSpacePrecent, sideBarWidth, spreadTypes } from '../../contants/strings';
import { getSize } from '../../../../common/utils/helper';
import './index.scss';


class PreviewModal extends Component {
  constructor(props) {
    super(props);
    this.state = this.initWorkspace();
  }
  componentDidMount() {
    this.addResizeEvent();
  }

  componentWillUnmount() {
    //window.onresize = null;
    window.removeEventListener("resize",this.resizeHandle.bind(this));
  }
  resizeHandle(event) {
    let timer = null;
    clearTimeout(timer);
    timer = setTimeout(() => {
      const index = this.getCurrentSpreadIndex();
      const state = this.initWorkspace();

      // resize后, 继续显示当前的spread, 而不是调到默认的spread中.
      if (index !== -1) {
        this.state.currentSpread = this.state.spreadOptions[index];
      }
      this.setState(state);
    }, 500);
  }
  addResizeEvent() {

     window.addEventListener("resize",this.resizeHandle.bind(this));

  }
  initWorkspace() {
    const { spreads, images, baseUrls } = this.props;
    const spreadOptions = this.formatSpreadOptions(spreads, images);
    const state = {
      baseUrls,

      // spread的绘制参数
      spreadOptions,

      // 当前显示的spread
      currentSpread: spreadOptions.length ? spreadOptions[0] : {}
    };

    return state;
  }

  formatSpreadOptions(spreads, images) {
    const { t } = this.props;
    const spreadsOptions = [];
    if (!spreads || !spreads.length) {
      return spreadsOptions;
    }

    const image = images && images.length ? images[0] : {};
    spreads.forEach((s) => {
      const pageSize = getSize();

      let wsPrecent;
      switch (s.type) {
        case spreadTypes.coverPage:
          wsPrecent = workSpacePrecent.big;
          break;
        case spreadTypes.innerPage:
          wsPrecent = workSpacePrecent.sm;
          break;
        default:
          break;
      }

      if (wsPrecent) {
        const workspaceWidth = (pageSize.width ) * wsPrecent;
        const rate = workspaceWidth / s.width;
        const left = sideBarWidth + (((pageSize.width - sideBarWidth) - workspaceWidth) / 2);
        const opt = merge({}, s, {
          width: s.width * rate,
          height: s.height * rate,
          bleedTop: s.bleedTop * rate,
          bleedBottom: s.bleedBottom * rate,
          bleedLeft: s.bleedLeft * rate,
          bleedRight: s.bleedRight * rate,
          spineThicknessWidth: s.spineThicknessWidth * rate,
          wrapSize: s.wrapSize * rate,
          textInCenter: s.textInCenter ? t(s.textInCenter) : ''
        });

        spreadsOptions.push({
          rate,
          pageSize,
          workspaceWidth,
          spreadOptions: opt,
          imagesOptions: image,
          originalOptions: s,
          left
        });
      }
    });

    return spreadsOptions;
  }

  onOutside() {
    const index = this.getCurrentSpreadIndex();
    const spreadOptions = this.state.spreadOptions;
    if (spreadOptions && spreadOptions.length && !Object.is(index, 0)) {
      this.setState({
        currentSpread: spreadOptions[0]
      });
    }
  }

  onInside() {
    const index = this.getCurrentSpreadIndex();
    const spreadOptions = this.state.spreadOptions;
    if (spreadOptions && spreadOptions.length > 1 && !Object.is(index, 1)) {
      this.setState({
        currentSpread: spreadOptions[1]
      });
    }
  }

  getCurrentSpreadIndex() {
    const index = this.state.spreadOptions.findIndex((v) => {
      return v.spreadOptions.id === this.state.currentSpread.spreadOptions.id;
    });

    return index;
  }

  render() {
    const {onClosed, opened, t} = this.props;
    const spreadWidth = this.state.currentSpread.spreadOptions.width;
    return (
      <XModal className="preview-modal" onClosed={ onClosed }
              opened={ opened }>
        <div className="box-preview">
          <hr className="hr-preview"/>
          <div className="container-preview" style={{height: window.innerHeight-50}}>

            <div className="spread-container" style={{marginLeft:window.innerWidth/2-spreadWidth/2}}>
              <Spread spreadId={this.state.currentSpread.spreadOptions.id}
                      spreadOptions={this.state.currentSpread.spreadOptions}
                      imagesOptions={this.state.currentSpread.imagesOptions}
                      isPreview={true}
              />
            </div>
            <div className="btn-list m-b-66">
              <OutInSide leftText={t('OUTSIDE')}
                         rightText={t('INSIDE')}
                         onLeftClicked={this.onOutside.bind(this)}
                         onRightClicked={this.onInside.bind(this)}
              />
            </div>
          </div>
        </div>
      </XModal>
    );
  }
}

PreviewModal.propTypes = {
  onClosed: PropTypes.func.isRequired,
  opened: PropTypes.bool.isRequired
};

export default translate('PreviewModal')(PreviewModal);
